
**注：主要讲EM planner**



# 参考资料
* [automatic-driving-decision-and-planning-for-matlab](https://github.com/VincentWong3/automatic-driving-decision-and-planning-for-matlab)

# 一、序章
[office](lK9Hw3d0JcJr4aTRAT4Q4NrxLgvR1hyKSQp-fsyjCPk.pdf)

![image](images/DQSgkKSgTrNf6Sl6E4JZY4q4nRWzSMIip8vy2JO9Udc.png)



这段内容主要涉及自动驾驶系统中的三个关键模块：导航规划算法、行为规划算法（又称决策算法）、运动规划算法。以下是每个模块的重要细节总结：

1. **导航规划算法**：
   * 计算从点a到点b的路径，类似于手机导航系统。
   * 与手机导航算法基本一致，适用于数公里到数百公里的距离。
   * 通常在整个规划模块中是最成熟的算法。
   * 提供粗略的大范围路径，但不考虑避障和车辆动力学的约束。
   * 一般只需要执行一次，除非遇到大范围的拥堵或施工偏航情况。
2. **行为规划算法（决策算法）**：
   * 决定车辆的行驶意图，包括静态障碍物的绕行和动态障碍物的避让或超车。
   * 是整个规划模块中最难的部分。
   * 提供车辆的行驶意图，指导避让、超车、左转或右转等决策。
   * 不提供具体的运动建议，需要较高的执行频率和一定的稳定性，不允许剧烈波动。一般为10hz
3. **运动规划算法**：
   * 根据决策算法给出的行为意图，在时空中搜索或优化出详细路径和速度信息。一般为10hz
   * 生成满足各种约束条件的轨迹，长度通常在几米到几十米之间。
   * 输出包含详细路径和速度信息的轨迹，用于控制模块跟踪。
   * 具有与决策频率相同的执行频率，需要一定的稳定性。



1. **关于L2的说明**：

* L2是一个相对宽泛的概念，功能差距较大，重要的是责任在驾驶员手中。
* 厂家可能将一些较复杂的L2称为L2加或L2.52等，但本质上是L2。
* 角色规划算法在L2中发挥关键作用，将普通的L2演变为具备更多功能的L2。
2.  **自动驾驶模块比喻**：
* 感知模块类比为人的眼睛和耳朵。
* 控制模块类比为人的小脑和双脚。
* 规划角色规划模块类比为人的大脑，功能越复杂，越重要。



![image](images/Aij-bqKXDZ4SVo4u_fxUA3jgnGJiiiAGpdeko__2iPk.png)

![image](images/0I80YgLyflqXtlllggFlzuEDW-LHT3FRZiNOHeKQquQ.png)

![image](images/t5d_d4xLjA0f4BxCXDNFx-oSTSS8g9bHzf6n8cfJsP8.png)

## 1 导航规划算法
![image](images/UA7mCUpTZbxHCukG8lCFo3ds9S69aIV3Rz3M_k20y5Q.png)

## 2 行为规划算法
![image](images/o7iAf9l8HJulJcLx6ZPy2lJ06dNwVayn6xfMWCNTkAQ.png)

## 3 运动规划算法
![image](images/KftHvVTL1e_2e1ma7B0YKU6gPnxo3VzWv4LECedVkiw.png)

## 4 主要内容
![image](images/iwpI6cvvxvYP2uP6PLjTDCSEBOe4bsFx8EhpNh09fVk.png)

# 二、五次多项式详解
[office](d8s9JiAZx9qoNlUZSM9H0ugjJa31DilenhORJD8OEZI.pdf)

以下是重要细节的总结：

1. **舒适性指标**：
   * 在车辆运动规划中，舒适性是一个重要指标。
   * 舒适性可以用加速度的导数，即“Jerk”（衡量加速度变化的速率）来衡量。
   * Jerk的绝对值越小，表示加速度变化越平缓，车辆运动越舒适。
2. **Jerk的定义**：
   * Jerk定义为Jerk = dA/dt，其中A是加速度。
   * 要使车辆运动轨迹舒适，需要使Jerk的绝对值尽量小。
3. **舒适性与五次多项式**：
   * 为了实现舒适的运动轨迹，引入了泛函的概念，其中包括五次多项式。
   * 通过最小化0到TF（总时间）内的Jerk的平方，找到使车辆运动舒适的五次多项式。
   * 数学问题就变成了，如果有一个函数S(T)，什么样的T会使得在0到T内的Jerk的绝对值变化平缓。由于绝对值的处理比较烦，所以一般改成平方，也就是说问题变为我们要找到一个T，使得这个积分0到T内的S的三阶导数的平方dT让它最小。
   * 
4. **泛函优化问题**：
   * 泛函优化问题的目标是找到一个FT，使得0到TF 3次导数的平方DT的积分最小。
   * 该问题包含带有六个边界条件的约束，其中包括起始位置、起始速度、起始加速度，以及终点位置、终点速度、终点加速度。
5. **解决泛函优化问题**：
   * 使用欧拉-拉格朗日方程进行泛函的变分计算。
   * 最终，得到FT的解是一个五次多项式，满足所有给定的边界条件，实现了最小Jerk的轨迹规划。
6. **五次多项式的特殊性**：
   * 五次多项式在自动驾驶规划中具有特殊地位，常常用于连接轨迹点以实现平滑的运动。
   * 五次多项式在约束条件下，能够使Jerk最小，从而提高车辆运动的舒适性。



## **五次多项式在规划中的优缺点如下：**
* 优点：
   * 五次多项式可以满足六个边界条件，包括初始和目标点的位置、速度和加速度¹²。
   * 五次多项式可以使Jerk（加速度的导数）的绝对值或平方在整个区间内最小，从而提高舒适性¹²。
   * 五次多项式可以用闭式解求出，计算简单。
* 缺点：
   * 五次多项式不能保证轨迹的曲率连续，可能会导致运动不平滑。
   * 五次多项式不能让机器人快速达到最大速度，提升效率。
   * 五次多项式不能处理更高阶的约束，例如Jerk或Snap。



![image](images/uZIEHD9f7xevWqkY8M0ir7j0up8xBuTWUdxmRubhgRM.png)

---
## 1 数学问题
![image](images/GIam_6aVnXCNNjy5gL2WoW0DyvPIzlQyUDbnnYe5Ztk.png)

![image](images/T4ztikAI515IFw-BJu7QuQYc10hYe-b13wcIFVLKS3g.png)

![image](images/Pq4E3KjD2JuNztfcK6bxH2N5va4jCM7NoVM5U3QcLOY.png)

## 2 解答
![image](images/h7uqf5b0r3ka2HAbB8RC4Ao1FkMlQnmV2jHBLaKcns8.png)

![image](images/fag_RNy07q1ib-3uCXgP9yAqEO5y4ifvT_qKfN6A2l0.png)

![image](images/yghFO7mMPUXW6L52bDpwQPXeHaZFZ0Bp3_IxWEnUaIw.png)

![image](images/ImpsYPwedkYT3HDk1YBuPZvINBV0Q0pIe3J8CYSZF_E.png)

# 三、二次规划（凸优化问题）
[office](OrzCTlyCs-xSGsfoF8-j3YM5Hv8eKCzBBWsR-ffXWEo.pdf)

[office](SrRSIeZvDUaAJbf6llt6ESlWkisEf86JHC6hQD12pKI.txt)

* 轨迹规划是自动驾驶的核心问题之一，它的目的是找到一条满足各种约束的最优的轨迹，然后把这条轨迹交给控制器去执行。轨迹规划的难点在于，既要考虑轨迹的平滑性、舒适性、长度和耗时等指标，又要考虑轨迹的连续性、碰撞避免、交通规则和车辆动力学等约束。如何在这些复杂的条件下，快速地找到最优的轨迹，是一个数学上的优化问题。
* 凸优化是一种比较广泛的概念，它包含了二次规划在内的一些特殊情况。凸优化的基本思想是，如果一个函数是凸的，那么它的最小值一定存在，并且可以通过一些迭代算法来快速地找到。凸优化的优点是，它的理论基础比较完善，它的求解过程比较稳定，它的计算速度比较快。凸优化的缺点是，它的适用范围比较有限，它的约束条件必须是凸的，它的目标函数必须是凸的，或者至少是可以转化为凸的。

**数学问题：**

* 数学问题，即在约束条件下求解代价函数的最小值。传统的求解最小值的方法涉及对端点和导数的计算，以及解导函数等。然而，对于高维、复杂约束的函数，这种方法不再适用。
* 举例说明了一个复杂函数，展示了求导和解零点的困难。在自动驾驶领域，计算速度是一个重要的指标，因此我们不采用传统的迭代法，而是选择迭代算法，如牛顿法、梯度下降法和高斯牛顿法。这些算法的计算速度较快，适用于处理复杂的多维函数和约束。

![image](images/pw5YdkwmT9BeXz1FVAtLrq9Qd7ly65XBGv1KX8rYQVg.png)

---
## 1 数学问题
![image](images/jXNpVBraRym5naH5Et5luatqy8U8KUVTTD15L8288-4.png)

![image](images/aH6pQEDs1wNqW71a6He7z6qGm90CYSCZOGMcibXsC1I.png)

* **一般求解复杂函数在复杂约束下的最小值问题都采用迭代法**

![image](images/IsD6hF18DviKwMMm07AXvJu9veRbqE0UsQXegdnZyr8.png)

## 2 迭代法
![image](images/d95ByBs3kzRmvPOTVwm_iewcNxixXbDNDHW3yHG5HAQ.png)

### 2.1 凸优化问题
在这段视频中，主讲者以梯度下降法为例，介绍了迭代法的基本原理和凸优化的相关概念。以下是主要内容的总结：

1. **梯度下降法基本原理：**
   * 给定一个初始值 (X\_0)，梯度下降法的目标是找到函数的最小值。
   * 迭代的方向由初始值的导数决定，如果是一元函数，就是导数；对于多元函数，则是梯度。
   * 迭代方向是梯度的反方向，即按照导数负方向迭代。
2. **迭代过程：**
   * 根据初始值的导数（梯度），判断下一步迭代的方向。
   * 根据导数的正负确定是向前还是向后迭代。
   * 通过迭代找到新的点，直到收敛为止。
3. **收敛判据：**
   * 收敛是指迭代到足够接近最小值的过程。
   * 收敛的判据既包括方向，也包括步长。方向由梯度的正负决定，步长由导数的大小决定。
4. **对初值的敏感性：**
   * 梯度下降法对初值敏感，初始值的不同可能导致不同的局部最小值。
   * 在函数有多个局部最小值的情况下，初值的选择影响着迭代结果。
5. **凸优化：**
   * 凸优化是一类特殊的优化问题，它要求目标函数是凸函数，且约束空间是凸空间。
   * 凸函数的定义包括对于函数内部的任意两点，连接它们的线段上的所有点也在函数内。
6. **凸空间：**
   * 凸空间是满足凸集定义的空间，其中任意两点的连线上的所有点也在空间内。
   * 凸空间是对于凸函数而言的，它的定义涉及到整个空间而不是函数的具体形状。
7. **凸函数：**
   * 凸函数是对于任意两点的线段上的点，函数值都在这个线段内，不会跳出这个区域。
   * 凸函数在凸空间内的最小值即为全局最小值。
8. **凹多边形和凸多边形：**
   * 凸多边形要求内部任意点的中点也在内部，而凹多边形则存在至少一个点使得中点不在内部。
9. **凸优化问题：**
   * 凸优化是在凸函数的约束下寻找最小值的问题，通常使用梯度下降法等迭代法进行求解。
10. **收敛性：**
   * 梯度下降法在凸优化问题中有较好的收敛性，能够收敛到全局最小值或约束边界。



![image](images/3bMjr2O9RxWFxOqYBTzmhNi53gkV7VqYH4-Ag0IQaPU.png)

![image](images/yaJj3ByZQcxLfiAlnjYg4J7LpSAAqL-BvBk0QzEwigI.png)

### 2.2 自动驾驶避障约束空间
凸优化是一种非线性的优化方法，它的特点是既简单又有效。它是人类目前掌握的唯一一种非线性优化方法，也是所有复杂优化方法的基础。凸优化的本质是要找到一个最小化或最大化某个函数的值的点，这个函数叫做代价函数，它反映了我们的优化目标。同时，这个点还要满足一些条件，这些条件叫做约束，它们反映了我们的优化限制。凸优化的要求是，这个代价函数必须是凸的，也就是说，它的曲线没有拐点，而且这些约束必须构成一个凸空间，也就是说，它们的边界没有凹陷，而且任意两点之间的连线都在这个空间内。如果满足这些要求，那么我们就可以用一些数学方法，比如梯度下降，来迭代地寻找这个最优点，而且这个最优点一定是全局最优的，也就是说，没有其他点比它更好。

自动驾驶的规划算法是一个非凸优化问题，它的难点就在于它的约束空间是非凸的，也就是说，它的解空间是非凸的。这就意味着，我们不能用简单的数学方法来寻找最优点，而且这个最优点也不一定是全局最优的，也就是说，可能还有其他点比它更好。这就需要我们用一些更复杂的优化方法，比如非线性规划，来解决这个问题，而且这个问题的解也非常依赖于我们的初始值，也就是说，我们的车辆的初始位置和速度。如果我们的初始值选得不好，那么我们可能会收敛到一个局部最优的点，也就是说，我们的车辆可能会卡在一个不好的位置，或者做出一个不好的动作，从而导致安全或效率的问题。

![image](images/KcGaRHSFJjOCzVrjUa2LSSrWDSOoZ5jcBc6F8R7bb9U.png)

---
### 2.3 如何求解非凸问题的最小值
**1\. 非凸优化问题的挑战：**

* 非凸优化问题是一类较为复杂的问题，当前并没有一个完美解决所有情况的算法。
* 不同的问题需要考虑不同的因素，缺乏通用解法。

**2\. 解决非凸问题的主要思路：**

* 求解非凸问题的一种主要思路是寻找其中的凸结构。
* 凸结构的例子包括函数是凸的，但约束空间不是凸空间的情况。

**3\. 主流算法：**

* 当面对非凸问题时，目前主流算法是一种启发式的方法。
* 启发式算法的核心思想是在约束空间内随机采样，并比较这些离散函数值的大小，选择最小值作为迭代的初始值。

**4\. 离散化与初值选择：**

* 通过在约束空间中离散化取样，比较这些采样点的函数值，选择最小值作为初值进行迭代。
* 初值的选择对最终解的收敛性和全局最小值的获取影响显著。

**5\. 粗解的作用：**

* 采样比较大小后得到的初值称为粗解，起到一个基础的作用。
* 粗解是基于离散化的约束空间的最优点，为后续迭代提供起点。

**6.非线性优化问题类似方法：**

* 针对非线性优化问题，采用类似的思路。首先在连续空间内采样，找到相对最小值的点作为初值。
* 采样的点越多，容易发生维度灾难的困境，采样点越少，容易受到局部最小值的影响。

**7\. 求解策略的限制：**

* 非凸优化和非线性优化问题的求解并没有通用的、精确的解决方案。
* 求解策略的选择需要根据具体问题的特点进行调整。

**8\. 采样点数量的问题：**

* 采样点数量的选择需要平衡局部最小值和全局最小值的获取，少则容易受局部最小值影响，多则可能导致维度灾难的困境。





![image](images/QQMpkWppDlVXVMT_jDdB23mQT-u82E0J-nXBgiGazPs.png)

![image](images/1XmW6mOEDFmWHA2stNmYaIIvy2AvbkwOwZBg8aTgecM.png)

![image](images/B9t8KrH1ydOLCtZZK6PnPCh6L9tQQYKzP5IU5AyZIo4.png)

# 四、Frenet与Cartesian坐标变换
**CSDN博客：**

* [Frenet坐标系与Cartesian坐标系互转（一）：公式推导](https://blog.csdn.net/u013468614/article/details/108748016)





* 43:03那里，是不是漏了个l
* 博客中的vx对应的是视频里的|v|，博客中的ax对应的是视频里的|v|的导数

## 博客公式
* [Frenet坐标系与Cartesian坐标系互转（一）：公式推导](https://blog.csdn.net/u013468614/article/details/108748016)

![image](images/ySf4PKt-GoyTBtu9QFAHZq38Sd-HuqjYBHV38QIa7MY.png)

![image](images/9hez9stQnWTOXWzyVNuHc5C3f9BPja83OAE2s4FRiwk.png)

![image](images/BaPzimj_csy9sos1zejLq-qqYZagD0CKu-X4SET-YF4.png)

![image](images/aNQHYlwp6U1Mb5UFKxKfcroIlodx-5QaVL8euuVBW3o.png)

### Cartesian和Frenet坐标变换
![image](images/JanNP7CMnb6qxEZtU2ypYZ3KpoDA1tUBrt_9XeifzNU.png)

![image](images/Luv_I6UdUrH1zvM1MozuWTdfrdqi1xvQ-RT9A2Ff-sk.png)



## 1 序章


![image](images/Z6tuEcGebWhDEtgHj1NfLBke0Zozvz0-sUGMnQig10k.png)

![image](images/iZF14BGoyWc2jcVxKswGV8Gs2r_BFwJmAG4S2FHnIlM.png)

### 1.1 预备知识1
![image](images/FuPHQODclV9UeTflaVRAS92HJlC4llkYiZJgd9mhFX0.png)

### 1.2 预备知识1（frenet公式）
![image](images/L-U1WDReXHmaiRK98Jg7pRp1ux7zh05KiRzy-XwlGTQ.png)

![image](images/LHb7moLHQW8xmGuZS1h7nkUbntgwZ22H54zHHy8uLuU.png)

### 1.3 求s,\\dot s,\\ddot s,l ,l^,,l^{,,}
* 对于EM planner，需要求出 $s,\dot s,\ddot s,l ,l^,,l^{,,}$ 
* 对于lattice planner，需要求出 $s,\dot s,\ddot s,l,\dot l,\ddot l$ 



![image](images/l7xL38qYA_3r_whVzPmkYUi1UQbXby-CsSEGHmg0f1U.png)

![image](images/ImintU5EeFt7wUNp3Otqcz-JTGzcb2d94FjdVQce07k.png)

![image](images/hqGNyZl5DX24cyx2ckilqbwyoZasOGgm-cMCjmLZPXo.png)

![image](images/iv6NoxIhmCNgMQLy7gJiVEUEJKN4u9XbNHLbfIh4gHI.png)

## 2 Cartesian到Frenet坐标变换（上）






1. **龙格现象：**
   * 提到了数值分析中的龙格现象，即使用高次多项式拟合可能出现的振荡现象。
   * 警告在离散化问题时，需要慎用高次多项式，建议使用分段的低次多项式。
2. **坐标转换的动机：**
   * 介绍为什么要将直角坐标转换为弗兰纳坐标，主要是因为道路的形状和长度各异。
   * 强调通过将直角坐标转换为自然坐标，可以简化不同道路的分析问题。
3. **坐标转换的难度：**
   * 指出坐标转换的难度相对较高，需要对微积分和曲线坐标系有深入的理解。
   * 警告学习者，即使只是应用基础结论也是可行的，无需深入理解推导过程。
4. ** 坐标转换的优势：**
   * 强调以道路中心线为曲线坐标系建立自然坐标的优势。
   * 表明通过坐标转换，可以统一不同道路和路况的分析方法，简化问题。


![image](images/XjRBXsQCyxJp81xV9joSvsiEjlQFvHu7fUuhbAi4omk.png)



### 2.1 EM planner和lattice planner的不同点
* 对于EM planner，需要求出 $s,\dot s,\ddot s,l ,l^,,l^{,,}$ 
* 对于lattice planner，需要求出 $s,\dot s,\ddot s,l,\dot l,\ddot l$ 



![image](images/IJRqUEFjf_ol3tRXzHnz5gorI-hJ5o2jg1ANTzwDPWM.png)

### 2.2 曲线坐标系
**曲线坐标系的特性：**

1. **迹向量不是常向量：** 在直角坐标系下，迹向量是i和j的线性组合，是一个常向量。而在曲线坐标系中，迹向量的方向会随着曲线路径的变化而变化，即d套/ds不为0。
2. **点的曲线坐标变化与实际位移不一致：** 在直角坐标系下，当一个点在x轴方向移动dx时，其实际位移也是dx。然而，在曲线坐标系中，点的曲线坐标变化（ds）与实际位移（ds一撇）一般不相等。

**导数在曲线坐标系中的复杂性：**

导数在曲线坐标系中变得更为复杂。在直角坐标系下，对向量求导只涉及到该向量的分量。但在曲线坐标系下，对速度向量的导数需要同时考虑速度的分量和曲线的弧长变化率。

**例子：**

* 在直角坐标系下，车辆速度向量为v = v\_xi + v\_yj。对该速度向量求导只需对v\_x和v\_y分别求导。
* 在曲线坐标系下，车辆速度向量为v = v\_x套 + v\_yn。对该速度向量求导时，除了对v\_x和v\_y求导外，还需对曲线坐标的套和n求导。

这一点是曲线坐标系与直角坐标系最大的不同之一，也是初学者感到困扰的重要原因。

**自然坐标系下的DS与DS一撇：**

在曲线坐标系中，有时我们会面临多个DS的情况，即DS和DSX。这是因为在自然坐标系下，点的曲线坐标变化和实际位移变化可能不同。因此，DS和DS一撇一般是不相等的。

**示例：**考虑车辆沿道路平行行驶，使车辆的l坐标保持不变。若车辆从红色位置移动到蓝色位置，车辆的DS和DSX均存在。此时，车速等于DSX/BDT，但投影速度等于S一点/BDT。这是因为DS和DSX的差异导致了速度不同。



![image](images/0oYXKc-Vpnl-jwPS2tmqGwjDJcYZR_tJ2T_XdNYt7IE.png)

![image](images/Lk2x6DKEA7W5a-Ai56WCjA-tZKy9CcblnxDsj1r28S8.png)



### 2.3 预备知识1（曲线坐标系）
首先，我们介绍了曲线坐标系的概念，这在数学中可能相对陌生。曲线坐标系的引入主要是为了更好地描述无人驾驶车辆在道路上行驶时的轨迹和几何关系。相较于大家熟悉的直角坐标系，曲线坐标系的使用在该领域中更为合适。

在曲线坐标系下，我们引入了一些关键概念，如弧微分（DS）和切线方向（套）。与直角坐标系不同的是，在曲线坐标系下，一个向量的导数不再是简单的DX或DY，而是涉及到曲率等更为复杂的因素。

我们详细讨论了曲线坐标系下的导数计算，强调了在直角坐标系下只有一个DX，而在曲线坐标系下可能存在多个DS。这一点可能让初学者感到不适应，因为曲线坐标系下的导数计算相对复杂，需要考虑到曲率等因素。









![image](images/xRaRcTCir3NCNkyuXnhr0SFmJ0BsJtY8Vyn38vRhJDE.png)

### 2.4 预备知识2 （frenet公式）
第二个预备知识是弗兰拉公式，这是一个重要的数学工具，用于解决曲线坐标系下的导数计算问题。弗兰拉公式提供了导数和曲率之间的关系，对于我们的问题具有重要的指导作用。

**弗兰拉公式的基本形式**

我们首先讨论了弗兰拉公式的基本形式，其中d套比DS等于曲率k乘以法向量n。这个公式是解决导数计算中的关键一环，使得我们能够更好地理解曲线坐标系下的数学关系。

**弗兰拉公式的扩展**

为了更全面地理解弗兰拉公式，我们引入了在质点轨迹和道路几何之间的关系。我们考虑了质点在曲线坐标系下的切线方向和投影在道路几何上的切线方向，通过引入曲率的不同来更为严谨地解释了公式的扩展形式。

**重要公式的导出**

在此部分，我们导出了一些重要的公式，如质点的切线方向和法向量的导数等。这些公式为我们后续的坐标转换问题提供了关键的数学工具。

![image](images/tI9koMeZ7m57u_pgV_Re_LgpEWs8Rkz8U0a2HDgliQQ.png)

![image](images/ltdpM6u5HKPloyhkoJQFG05XFXtjq5gsrsxXhj7ZONQ.png)

**加速度的计算**

我们详细推导了加速度（a）的计算公式。通过引入速度的导数和曲率，我们得到了切向加速度和法向加速度的表达式，其中法向加速度又被称为向心加速度。这一计算对于无人驾驶车辆在转弯等情境下的运动控制非常关键。

**曲率对加速度的影响**

我们说明了曲率对加速度方向的影响，特别强调了曲率的符号对于向心加速度方向的决定性作用。这一点有助于理解在不同曲率下车辆的运动特性。





### 2.5 总结


![image](images/lPOeHUzrXhQo1dq2MM5v1zq6hBa-eE8QMS31ci6cVRw.png)

![image](images/cLAwDig94URluujiopzQvBUFBBl_FSsM_GmB9F6E4v0.png)



接下来，我们列举了与坐标转换相关的所有变量，这些变量以低卡坐标为基准。这包括了车辆的位置（Rh）、速度（v）、加速度（a）、车轨迹上的曲率（kh）、切线方向（toh）、法线方向（noh），以及投影位置在道路几何上的相关变量。

首先，利用前面介绍的七个辅助公式，我们找到了车辆在弗兰纳坐标系下的投影点的坐标。其次，我们计算了投影点在低卡坐标系下的位置和相关的方向。最后，通过应用三角形几何和微积分的方法，我们成功地推导出了弗兰纳坐标系下的SS1、S2，以及LL1、L2。

![image](images/w_76bvhuX0KqKsSaOJ-Hw9g_Ai3iS3JR6mZn7b7umJo.png)

![image](images/aIGYIzMkBLs2X0Giyhv_WmRsEN9N3LP1f8yiml3FwK8.png)

![image](images/2N7VDcaBfsgoS8GGQFj8_JBLXPueyUYzLKuzM8aEK_s.png)

![image](images/FNCYl5xY8nYt1nymfEgcb_8DhyAxBp1I6BNwOp1vq1s.png)

需要注意的是，其中的一些推导使用了向量法，作者强调了向量法的简洁性，并尽量减少了一些冗长的计算过程。在最后，作者提到还有一个坐标点 S 没有算，因为 S 与投影点相关，而投影点的计算将在下一讲进行。

![image](images/jrZnXyGUcBCb8Z3bJJCDB8p7TKHOiHxqXhWNudJaxrI.png)

## 3 Frenet与Cartesian坐标变换（下）


[office](AMlizhTnaJPFUcfy--MkggJ4BbH0n3xH8kwOQqBHHlU.txt)

![image](images/zRVbU3CDUXORN6Zols8ydM64U3316SpnCZQbvt5R36U.png)

### 3.1 如何计算投影点的xr, yr,  $\theta_r$ ,kr


1. **计算XR、YR、CR、KR**：
   * 强调了在自动驾驶控制算法第七讲已经讲解过这一问题。
   * 提到了在实际情况中，reference line 通常是离散点，需要讨论离散点的投影计算。
   * 描述了通过曲线上的离散点的切线方向、曲率等参数来进行投影的近似解法。
   * 提到了近似认为Kr等于Km（匹配点的切线方向）。
2. **投影计算过程**：
   * 通过遍历离散曲线，计算车辆到曲线上各点的距离，找到最短距离对应的点作为匹配点。
   * 使用匹配点的坐标和切线方向计算投影的近似解，其中涉及到一些向量运算和坐标转换。
   * 介绍了投影的计算原理，通过匹配点的位置和d、套的计算来近似计算投影位置。
3. **投影的精度与限制**：
   * 提到由于离散曲线相较于连续曲线信息较少，因此得到的投影是一个近似解。
   * 讨论了在实际应用中，只要这个近似的精度足够满足自动驾驶的要求，就是可接受的。



![image](images/ry8fInXwgPzGGhg4Ll4iQ4-K3ZtDHF5ViBAGpXkRe8I.png)

![image](images/pD-AC-Z5-wEnrXjoNvTqTVbBI5_6asmDnpJP-pG6toI.png)

### 3.2 如何计算s
计算s的方法是从起点开始，累加各个路径点之间的直线长度，一直加到投影点为止。这种近似方法的核心思想是以直线代替曲线，通过累加直线长度得到路径长度的近似值。作者强调了这种算法的简单性和稳定性。

尽管有更精确的算法，比如通过曲率半径计算弧长，但作者指出这些算法在稳定性上不如分段直线近似曲线的算法。他提到了对参数的敏感性，以及在实际应用中的误差累积问题。

对于规划长度在几十米到几百米的路径，该算法是合适的，因为在这个范围内，算法的误差是可以忽略的。然而，对于更长的路径规划，特别是几公里到几百公里的情况，该算法的误差累积可能变得显著。

1. **矛盾与平衡**：
   * 提到自动驾驶面临两个矛盾：需要快速运算，同时需要高精度。
   * 强调不同算法采用近似手段是为了平衡这两个矛盾。
2. **实践性与理论性**：
   * 将自动驾驶描述为一门技术而非学科，强调其实践性。
   * 指出即使理论完美，实践不行也不可行。
3. **路径长度计算的近似算法**：
   * 提到路径长度计算的算法看似粗糙，但其实践效果是关键。
   * 强调实践中的运行结果是评判算法效果的关键。
4. **计算路径长度s的算法**：
   * 描述了一种简单的算法，从起点开始，累加各个路径点之间的直线长度，直到投影点为止。
   * 强调了该算法本质上是用直线代替弧长，通过累加直线长度近似路径长度s。
   * 讨论了算法的精度，指出误差在路径点足够密集时是可以忽略的。
   * 提到该算法可能在较长路径中积累误差，但在短距离规划中是可接受的。
5. **精确算法的问题**：
   * 提到存在更精确的算法，但它们也各自存在问题。
   * 以曲率计算为例，指出某些算法对参数的变化非常敏感，导致不稳定。
   * 讨论了一个精确的曲率计算算法，但强调了其不稳定性。
6. **算法的简单性与稳定性**：
   * 强调算法的简单性和易实现性。
   * 提到该算法的稳定性，即对参数变化不敏感，具有鲁棒性。
   * 稳定性在实践中是一个重要的考虑因素。
7. **对比其他精确算法**：
   * 提到其他精确算法可能存在对参数变化敏感或计算耗时过长的问题。
   * 指出综合来看，相对较糙的算法在大多数情况下是最合适的。
8. **灵活处理特殊情况**：
   * 强调该算法在大多数情况下适用，对于需要更精确处理的特殊场景可以进行单独处理。

![image](images/DcVHF9Bznf7Ggy1a1Qq8oQwY3ea0AKYaypgnSLvzrSs.png)

![image](images/Jf2olCjOdi5Tn7-xQovqTcqoYFdvHbCKaWm1VNi_yl0.png)

### 3.3 Frenet与Cartesian坐标变换
这段文字涉及到从自然坐标系转换到直角坐标系的问题，其中包括已知S点、L点、以及相关的一些坐标信息，通过这些信息计算r\_h、v\_h、a\_h和k\_h。整个过程涉及到坐标系的转换、向量计算、曲率的求解等数学问题。主要步骤包括：

1. 计算x\_i对s\_i的映射对应表。
2. 查找x\_i与s\_i的对应表，找到s\_n，得到x\_n和 $x_{n+1}$ 
3. 计算r\_d，代入公式得到r\_h。
4. 计算v\_h，通过公式二三推导得到V的大小和方向。
5. 计算a\_h，利用已知的S和L点信息，反过来计算a\_h的向量表示。
6. 计算k\_h，利用a\_h、nr和v的模的导数等信息。





![image](images/giLGoebg0AQcf-2YfD8cuzpNkraAts8-yx75Ez0vRE4.png)



![image](images/KTaNGBggJNo0yWExkNozpvye7VM0cFadopomcxhUhpU.png)



![image](images/2QpjdnhHLIH8lrxM_7u1IVuuJWSxCOnqrsb6MpxAV_4.png)

![image](images/QoUG1FnS9Lqlt5RQkhH6Qug7_wfzWXShQflBYzP-98w.png)

![image](images/elfMQHPN_I5nRIrYoJT9B4XasL8hSLhCYp00x4KWFII.png)

![image](images/1CLPC1C6uhC7amO5ejwxJs0qOTCTSAkktyuaWlURuLc.png)

